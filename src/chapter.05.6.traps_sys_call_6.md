# 5.7 PLIC机制

在RISC-V架构中，PLIC（Platform-Level Interrupt Controller）是负责管理和分配外部中断的组件。PLIC作为中断控制器，其主要职责是接受来自外部设备的中断信号，然后根据中断优先级和配置将中断传递给处理器核心。

当一个中断被PLIC发送到CPU，并且CPU成功地接受并处理这个中断时，会涉及到PLIC寄存器的一些修改。这些修改可能包括：

1. **中断处理登记**：当CPU接受并开始处理一个中断时，相应的中断在PLIC中可能被标记为“正在服务”（Claimed）。
2. **中断优先级**：中断服务程序可能会修改PLIC中的优先级寄存器，以改变不同中断源的优先级。
3. **中断完成**：当中断处理完成后，

**CPU通过写入PLIC的一个特定寄存器来通知PLIC中断已经被处理（Completed），这样PLIC就可以清除该中断的“正在服务”状态，并准备接收来自同一中断源的下一个中断信号!!!**

1. **使能和配置**：中断处理程序可能会根据需要在PLIC中启用或禁用特定中断源，或者更改配置，以适应系统的动态需求。

所以，是的，PLIC确实会根据中断的处理情况进行相应的寄存器修改。这些修改是由处理器在中断处理的不同阶段执行的，用以管理整个中断生命周期，从接收、处理到标记为完成。这确保了系统可以正确地响应接下来的中断请求。



## 1. SCLAIM:

监督模式下，中断声明

在RISC-V中，PLIC（Platform-Level Interrupt Controller）负责管理外部中断。其中，`SCLAIM`寄存器是用于监督模式（Supervisor Mode）的中断声明（claim）和完成（complete）的。

### `SCLAIM`寄存器的赋值：

当一个外部中断被PLIC路由到处理器，并且处理器处于准备好接受中断的状态时，中断服务例程通常开始于读取`SCLAIM`寄存器。这个读取操作执行两个主要功能：

1. **声明中断**：告诉PLIC处理器正在开始处理哪一个中断。`SCLAIM`寄存器读取的值是当前最高优先级中断的ID。这个ID用于识别是哪个外部设备触发了中断。
2. **获取中断**：从PLIC的角度看，读取`SCLAIM`寄存器意味着处理器正在认领一个中断。一旦处理器读取了`SCLAIM`寄存器，PLIC会认为该中断正在被处理，并不会再次将其发送到任何处理器，直到该中断被显式地完成（cleared）。

### `SCLAIM`寄存器的清理：

一旦处理器完成了中断处理，它必须向PLIC指示该特定中断已被处理完毕。这通常是通过写入`SCLAIM`寄存器完成的：

1. **写入中断ID**：处理器将处理完成的中断ID写回`SCLAIM`寄存器，这个操作通知PLIC特定的中断处理已经结束。
2. **清除声明状态**：写入`SCLAIM`寄存器通知PLIC可以清除对应中断的“正在服务”状态，并且相应的中断源可以再次被认领。

通过读写`SCLAIM`寄存器来声明和完成中断，PLIC与处理器之间能够协调中断处理的生命周期，确保每个中断只被处理一次，并且在处理完成之前不会重复触发。这是一种同步机制，确保了中断处理的正确性和系统的稳定性。



在RISC-V的PLIC（Platform-Level Interrupt Controller）中，`SCLAIM`不是一个特定的物理寄存器名称，而是通常用于指代与监督者模式相关的中断“认领”（claim）和“完成”（complete）寄存器的操作。这些操作通常是通过读取和写入同一个特定的内存映射地址来完成的，而具体的行为（认领或完成）则取决于访问的是读操作还是写操作。

**当处理器从这个地址读取时，它会从PLIC中认领一个等待处理的中断**，该操作会返回引起中断的设备的唯一标识符（即中断源ID）。处理器用这个ID来处理相应的中断。

**完成对中断的处理之后，处理器会通过向同一个地址写入中断源ID来告诉PLIC中断处理已经完成。这样，PLIC知道可以清除此中断的状态，并且如果有必要，可以再次对其进行处理。**

在RISC-V的文档和开发中，`SCLAIM`是一种抽象概念，代表了监督者模式下进行中断认领和完成的操作，而不是一个特定的硬件寄存器。对于`SCLAIM`的读写访问通常会通过内存映射的IO来实现，并且这个地址通常由操作系统或者中断处理库来管理。

在RISC-V体系结构中，Platform-Level Interrupt Controller（PLIC）是负责管理多个中断源的组件。它的设计旨在允许软件查询中断源、设置中断优先级、使能中断，并且控制中断到处理器核心的分配。以下是PLIC中涉及的一些关键寄存器及其作用：



1. Priority Registers

- **作用**：这些寄存器为每个中断源设置优先级。中断优先级决定了中断处理的顺序，具有更高优先级的中断会首先被处理。
- Pending Bit Array

- **作用**：这个寄存器数组指示哪些中断源目前是待处理的。如果某个中断源是活跃的并且尚未被处理，相应的位会被设置。
- Enable Registers

- **作用**：这些寄存器用于使能或禁用中断。通过这些寄存器，软件可以控制是否允许中断源产生中断。
- Threshold Register

- **作用**：这个寄存器设置当前处理器的中断接受阈值。只有优先级高于这个阈值的中断才能被送达给处理器。
- Claim/Complete Registers（例如`SCLAIM`）

- **作用**：读取这些寄存器可以声明处理器将要处理的下一个可用中断。处理完成后，写回这个寄存器可以标记中断已完成。
- Interrupt Source ID Registers

- **作用**：这些寄存器包含被认领的中断源的ID，可以帮助确定哪个设备产生了中断。
- Context or Hart-Specific Registers

- **作用**：这些寄存器为每个处理器核心（或硬件线程，hart）提供了上述功能的上下文。这允许PLIC为每个核心管理中断。

在RISC-V的PLIC中，这些寄存器是通过内存映射的输入/输出进行访问的，意味着PLIC的寄存器被映射到处理器的地址空间内，软件可以通过读写内存地址来读写PLIC寄存器。

不同的RISC-V实现可能会对PLIC进行定制，因此提供的功能和寄存器可能会有所不同。上面列出的是PLIC的基本组成部分，在特定的RISC-V实现中，可能还有其他与中断管理相关的寄存器。